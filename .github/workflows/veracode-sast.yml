name: Veracode Demo - SAST
on:
  push:
    branches:
      - pipeline-scan
      - policy-scan
      - sandbox-scan

jobs:
  Veracode-SAST-Pipeline:
    if: false
    ##if: github.ref == 'refs/heads/pipeline-scan'
    name: Veracode SAST Pipeline
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    env:
      APPLICATION_NAME: Verademo-python
      ## POLICY_NAME: Policy-test-2
      POLICY_NAME: Veracode Recommended High
    container:
      image: veracode/pipeline-scan:latest
      options: --user root

    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Zip & Scan
        run: |
          zip -r -v ${{ vars.TARGET_FILE_NAME }} . -i '*.py' '*.js' '*.html'
          java -jar /opt/veracode/pipeline-scan.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -f ${{ vars.TARGET_FILE_NAME }} -p "${{ env.APPLICATION_NAME }}" -pn "${{ env.POLICY_NAME }}"
          ## java -jar /opt/veracode/pipeline-scan.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -rp "${{ env.POLICY_NAME }}" && java -jar /opt/veracode/pipeline-scan.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -f ${{ vars.TARGET_FILE_NAME }} -p "${{ env.APPLICATION_NAME }}" --policy_file "${{ env.POLICY_NAME }}.json"
        continue-on-error: true

  Veracode-SAST-Policy:
    if: true
    ## if: github.ref == 'refs/heads/policy-scan'
    name: Veracode SAST Policy
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    env:
      APPLICATION_NAME: Verademo-python-2
    container:
      image: veracode/api-wrapper-java:latest
      options: --user root

    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Zip & Scan
        run: |
          zip -r -v ${{ vars.TARGET_FILE_NAME }} . -i '*.py' '*.js' '*.html'
          java -jar /opt/veracode/api-wrapper.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -action UploadAndScan -deleteincompletescan 2 -createprofile true -appname "${{ env.APPLICATION_NAME }}" -version "${{ github.run_id }}" -filepath ${{ vars.TARGET_FILE_NAME }}
        continue-on-error: true
  

    

  Veracode-SAST-Sandbox:
    ## if: github.ref == 'refs/heads/sandbox-scan'
    if: false
    name: Veracode SAST Sandbox
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    env:
      APPLICATION_NAME: Verademo-python-1
    container:
      image: veracode/api-wrapper-java:latest
      options: --user root

    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Scan
        run: |
          zip -r -v ${{ vars.TARGET_FILE_NAME }} . -i '*.py' '*.js' '*.html'
          java -jar /opt/veracode/api-wrapper.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -action UploadAndScan -createsandbox true -sandboxname "${{ github.ref }}" -deleteincompletescan 2  -createprofile false -appname "${{ env.APPLICATION_NAME }}" -version "${{ github.run_id }}" -filepath ${{ vars.TARGET_FILE_NAME }}
        continue-on-error: true